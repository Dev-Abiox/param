name: Testing Environment Deployment

on:
  push:
    branches: [ develop, staging, feature/** ]
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'develop'

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ghcr.io/dev-abiox/param
  FRONTEND_IMAGE: ghcr.io/dev-abiox/param-frontend

jobs:
  build-test-images:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push backend
      uses: docker/build-push-action@v5
      with:
        context: ./backend_v3
        push: true
        tags: |
          ${{ env.BACKEND_IMAGE }}:test-latest
          ${{ env.BACKEND_IMAGE }}:test-${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build and push frontend
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        push: true
        tags: |
          ${{ env.FRONTEND_IMAGE }}:test-latest
          ${{ env.FRONTEND_IMAGE }}:test-${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy-to-testing:
    needs: build-test-images
    runs-on: ubuntu-latest

    environment: testing

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup SSH agent
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Copy config files to server
      run: |
        SSH_OPTS="-o StrictHostKeyChecking=no -o HostKeyAlgorithms=+ssh-rsa -o PubkeyAcceptedAlgorithms=+ssh-rsa"
        SERVER="root@${{ secrets.HOST_IP }}"
        BASE="/opt/clinomic-b12-platform"

        ssh $SSH_OPTS $SERVER "mkdir -p $BASE/ml/models"
        scp $SSH_OPTS docker-compose.prod.yml $SERVER:$BASE/docker-compose.prod.yml
        scp $SSH_OPTS docker-compose.testing.yml $SERVER:$BASE/docker-compose.testing.yml
        scp $SSH_OPTS nginx.testing.conf $SERVER:$BASE/nginx.testing.conf
        scp $SSH_OPTS -r backend_v3/ml/models/ $SERVER:$BASE/ml/

    - name: Deploy testing stack
      run: |
        ssh \
          -o StrictHostKeyChecking=no \
          -o HostKeyAlgorithms=+ssh-rsa \
          -o PubkeyAcceptedAlgorithms=+ssh-rsa \
          root@${{ secrets.HOST_IP }} << 'EOF'

        set -e

        BASE=/opt/clinomic-b12-platform

        echo "=== ENSURING SHARED DOCKER NETWORK ==="
        docker network create clinomic_network 2>/dev/null || true

        echo "=== ENSURING TESTING STATIC VOLUME ==="
        docker volume create static_testing_volume 2>/dev/null || true

        echo "=== PULLING NEW TEST IMAGES ==="
        cd $BASE
        docker-compose -f docker-compose.testing.yml pull

        echo "=== RESTARTING TESTING STACK ==="
        docker-compose -f docker-compose.testing.yml down || true
        docker-compose -f docker-compose.testing.yml up -d

        echo "=== RESTARTING NGINX (prod) TO PICK UP TESTING CONFIG ==="
        docker-compose -f docker-compose.prod.yml up -d --force-recreate nginx

        echo "=== WARMING UP SERVICES ==="
        sleep 30

        echo "=== HEALTH CHECK ==="
        if curl -f -H "Host: testing.clinomiclabs.com" http://localhost:8000/api/health/live 2>/dev/null; then
          echo "Testing backend health check passed"
        else
          echo "Testing backend health check failed - checking logs..."
          docker-compose -f docker-compose.testing.yml logs --tail=50 backend_testing
        fi

        # Verify production still works
        if curl -f -H "Host: clinomiclabs.com" https://localhost/api/health/live -k 2>/dev/null; then
          echo "Production health check still passing"
        else
          echo "WARNING: Production health check failed after testing deploy"
        fi

        echo "=== TESTING DEPLOYMENT COMPLETE ==="
        echo "URL: https://testing.clinomiclabs.com"

        EOF
