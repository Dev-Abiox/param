deploy:
  needs: build
  runs-on: ubuntu-latest

  steps:
    - name: Bulletproof Blue-Green Deploy
      run: |
        ssh \
          -o StrictHostKeyChecking=no \
          -o HostKeyAlgorithms=+ssh-rsa \
          -o PubkeyAcceptedAlgorithms=+ssh-rsa \
          root@${{ secrets.HOST_IP }} << 'EOF'

        set -e

        BASE=/opt/clinomic-b12-platform
        COMPOSE="$BASE/docker-compose.prod.yml"

        echo "=== VALIDATION ==="

        [ -f "$COMPOSE" ] || { echo "Compose missing"; exit 1; }
        [ -f "$BASE/nginx.prod.conf" ] || { echo "Nginx config missing"; exit 1; }

        echo "=== DETECT CURRENT ==="
        CURRENT=$(cat $BASE/current_env 2>/dev/null || echo blue)

        if [ "$CURRENT" = "blue" ]; then
          NEXT="green"
        else
          NEXT="blue"
        fi

        echo "Current: $CURRENT"
        echo "Next: $NEXT"

        cd $BASE/$NEXT

        echo "=== SNAPSHOT RUNNING STATE ==="
        docker ps > $BASE/rollback_ps.txt

        echo "=== PULL IMAGES ==="
        docker-compose -f $COMPOSE pull

        echo "=== START NEXT ENV ==="
        docker-compose -f $COMPOSE up -d

        echo "=== WAIT FOR BOOT ==="
        sleep 45

        ##################################
        # HEALTH CHECKS
        ##################################

        FAIL=0

        echo "Check containers running..."
        docker-compose -f $COMPOSE ps | grep Up || FAIL=1

        echo "Check backend responds..."
        curl -sf http://localhost:8000 || FAIL=1

        echo "Check HTTPS via nginx..."
        curl -skf https://localhost || FAIL=1

        ##################################
        # ROLLBACK LOGIC
        ##################################

        if [ "$FAIL" -eq 1 ]; then
          echo "=== HEALTH FAILED â†’ ROLLBACK ==="

          docker-compose -f $COMPOSE down

          echo "Restoring previous env..."
          cd $BASE/$CURRENT
          docker-compose -f $COMPOSE up -d

          echo "ROLLBACK COMPLETE"
          exit 1
        fi

        ##################################
        # SWITCH LIVE
        ##################################

        echo "=== SWITCH TRAFFIC ==="
        echo $NEXT > $BASE/current_env

        ##################################
        # STOP OLD ENV
        ##################################

        echo "=== STOP OLD ==="
        cd $BASE/$CURRENT
        docker-compose -f $COMPOSE down || true

        echo "=== DEPLOY SUCCESS ==="

        EOF
