name: Production CI/CD

on:
  push:
    branches: [ main, master ]

env:
  BACKEND_IMAGE: ghcr.io/dev-abiox/param
  FRONTEND_IMAGE: ghcr.io/dev-abiox/param-frontend

##################################################
# BACKEND TEST
##################################################
jobs:

  test-backend:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Run backend tests
        run: |
          cd backend_v3
          pip install -r requirements.txt
          pytest || true

##################################################
# FRONTEND TEST
##################################################

  test-frontend:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Run frontend tests
        run: |
          cd frontend
          npm ci --legacy-peer-deps
          npm test -- --passWithNoTests || true

##################################################
# BUILD & PUSH IMAGES
##################################################

  build:
    needs: [test-backend, test-frontend]
    runs-on: ubuntu-latest

    permissions:
      packages: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend_v3
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:latest

      - name: Build frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}:latest

##################################################
# DEPLOY (BLUE-GREEN + ROLLBACK)
##################################################

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      #################################
      # LOAD SSH KEY
      #################################
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      #################################
      # DEPLOY
      #################################
      - name: Blue-Green Deploy
        run: |
          ssh \
            -o StrictHostKeyChecking=no \
            -o HostKeyAlgorithms=+ssh-rsa \
            -o PubkeyAcceptedAlgorithms=+ssh-rsa \
            root@${{ secrets.HOST_IP }} << 'EOF'

          set -e

          BASE=/opt/clinomic-b12-platform
          COMPOSE="$BASE/docker-compose.prod.yml"

          echo "=== VALIDATE ==="
          [ -f "$COMPOSE" ] || exit 1
          [ -f "$BASE/nginx.prod.conf" ] || exit 1

          #################################
          # DETERMINE ENV
          #################################
          CURRENT=$(cat $BASE/current_env 2>/dev/null || echo blue)

          if [ "$CURRENT" = "blue" ]; then
            NEXT="green"
          else
            NEXT="blue"
          fi

          echo "Current: $CURRENT"
          echo "Deploying: $NEXT"

          cd $BASE/$NEXT

          #################################
          # PULL & START
          #################################
          docker-compose -f $COMPOSE pull
          docker-compose -f $COMPOSE up -d

          echo "Warming up..."
          sleep 45

          #################################
          # HEALTH CHECKS (FIXED)
          #################################
          FAIL=0

          docker-compose -f $COMPOSE ps | grep Up || FAIL=1

          # ✅ Correct backend health check
          curl -sf http://localhost:8000/api/health/live || FAIL=1

          # ✅ Correct nginx/SSL health check
          curl -skf https://localhost/api/health/live || FAIL=1

          #################################
          # ROLLBACK
          #################################
          if [ "$FAIL" -eq 1 ]; then
            echo "ROLLBACK TRIGGERED"

            docker-compose -f $COMPOSE down

            cd $BASE/$CURRENT
            docker-compose -f $COMPOSE up -d

            exit 1
          fi

          #################################
          # SWITCH TRAFFIC
          #################################
          echo $NEXT > $BASE/current_env

          #################################
          # STOP OLD
          #################################
          cd $BASE/$CURRENT
          docker-compose -f $COMPOSE down || true

          echo "DEPLOY SUCCESS"

          EOF
