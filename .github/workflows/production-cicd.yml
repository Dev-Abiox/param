name: Production CI/CD

on:
  push:
    branches: [main, master]

env:
  BACKEND_IMAGE: ghcr.io/dev-abiox/param
  FRONTEND_IMAGE: ghcr.io/dev-abiox/param-frontend

##################################################
# TEST BACKEND
##################################################
jobs:
  test-backend:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Test backend
        run: |
          cd backend_v3
          pip install -r requirements.txt
          pytest || true

##################################################
# TEST FRONTEND
##################################################
  test-frontend:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Test frontend
        run: |
          cd frontend
          npm ci --legacy-peer-deps
          npm test -- --passWithNoTests || true

##################################################
# BUILD & PUSH
##################################################
  build:
    needs: [test-backend, test-frontend]
    runs-on: ubuntu-latest

    permissions:
      packages: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend_v3
          push: true
          tags: ${{ env.BACKEND_IMAGE }}:latest

      - name: Build frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ env.FRONTEND_IMAGE }}:latest

##################################################
# DEPLOY (BULLETPROOF BLUE-GREEN)
##################################################
  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Blue-Green Deploy
        run: |
          ssh \
            -o StrictHostKeyChecking=no \
            -o HostKeyAlgorithms=+ssh-rsa \
            -o PubkeyAcceptedAlgorithms=+ssh-rsa \
            root@${{ secrets.HOST_IP }} << 'EOF'

          set -e

          BASE=/opt/clinomic-b12-platform
          COMPOSE="$BASE/docker-compose.prod.yml"

          echo "=== VALIDATION ==="
          [ -f "$COMPOSE" ] || exit 1
          [ -f "$BASE/nginx.prod.conf" ] || exit 1

          echo "=== DETECT CURRENT ENV ==="
          CURRENT=$(cat $BASE/current_env 2>/dev/null || echo blue)

          if [ "$CURRENT" = "blue" ]; then
            NEXT="green"
          else
            NEXT="blue"
          fi

          echo "Current: $CURRENT"
          echo "Next: $NEXT"

          cd $BASE/$NEXT

          echo "=== PULL IMAGES ==="
          docker-compose -f $COMPOSE pull

          echo "=== START NEXT ==="
          docker-compose -f $COMPOSE up -d

          echo "=== WARMUP ==="
          sleep 45

          FAIL=0

          echo "Check containers..."
          docker-compose -f $COMPOSE ps | grep Up || FAIL=1

          echo "Check backend..."
          curl -sf http://localhost:8000 || FAIL=1

          echo "Check nginx..."
          curl -skf https://localhost || FAIL=1

          if [ "$FAIL" -eq 1 ]; then
            echo "=== ROLLBACK ==="
            docker-compose -f $COMPOSE down
            cd $BASE/$CURRENT
            docker-compose -f $COMPOSE up -d
            exit 1
          fi

          echo "=== SWITCH ==="
          echo $NEXT > $BASE/current_env

          echo "=== STOP OLD ==="
          cd $BASE/$CURRENT
          docker-compose -f $COMPOSE down || true

          echo "=== DEPLOY SUCCESS ==="

          EOF
