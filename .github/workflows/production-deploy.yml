name: Production Deploy

on:
  push:
    branches: [ main, master ]

env:
  BACKEND_IMAGE: ghcr.io/dev-abiox/param
  FRONTEND_IMAGE: ghcr.io/dev-abiox/param-frontend

jobs:
  test-backend:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: clinomic_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Run backend tests
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_DB: clinomic_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        run: |
          cd backend_v3
          pip install -r requirements.txt
          pytest

  test-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Run frontend tests
        run: |
          cd frontend
          npm ci --legacy-peer-deps
          CI=true npm test -- --watchAll=false --passWithNoTests

  build:
    needs: [test-backend, test-frontend]
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend_v3
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:latest
      - name: Build frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      - name: Copy config files to server
        run: |
          SSH_OPTS="-o StrictHostKeyChecking=no -o HostKeyAlgorithms=+ssh-rsa -o PubkeyAcceptedAlgorithms=+ssh-rsa"
          SERVER="root@${{ secrets.HOST_IP }}"
          ssh $SSH_OPTS $SERVER "mkdir -p /opt/clinomic/ml/models"
          scp $SSH_OPTS docker-compose.prod.yml $SERVER:/opt/clinomic/docker-compose.prod.yml
          scp $SSH_OPTS nginx.prod.conf $SERVER:/opt/clinomic/nginx.prod.conf
          scp $SSH_OPTS -r backend_v3/ml/models/ $SERVER:/opt/clinomic/ml/
      - name: Deploy to Production (No Rollback)
        run: |
          ssh \
            -o StrictHostKeyChecking=no \
            -o HostKeyAlgorithms=+ssh-rsa \
            -o PubkeyAcceptedAlgorithms=+ssh-rsa \
            root@${{ secrets.HOST_IP }} << 'EOF'

          set -e

          BASE=/opt/clinomic
          COMPOSE="$BASE/docker-compose.prod.yml"

          echo "=== VALIDATING DEPLOYMENT ==="
          [ -f "$COMPOSE" ] || exit 1
          [ -f "$BASE/nginx.prod.conf" ] || exit 1

          echo "=== PULLING NEW IMAGES ==="
          cd $BASE
          docker-compose -f $COMPOSE pull

          echo "=== RECREATING CONTAINERS ==="
          docker-compose -f $COMPOSE up -d --force-recreate

          echo "=== WARMING UP SERVICES ==="
          sleep 30

          echo "=== HEALTH CHECK ==="
          # Perform health check but don't fail deployment
          if curl -f -H "Host: clinomiclabs.com" http://localhost:8000/api/health/live; then
            echo "✓ Backend health check passed"
          else
            echo "⚠ Backend health check failed (continuing deployment)"
          fi

          if curl -f http://localhost:3000/; then
            echo "✓ Frontend health check passed"
          else
            echo "⚠ Frontend health check failed (continuing deployment)"
          fi

          echo "✅ DEPLOYMENT COMPLETED SUCCESSFULLY (Rollback Disabled)"

          EOF